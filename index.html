<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æç®€å¿ƒç‡</title>
    <style>
        /* 1. åŸºç¡€å¸ƒå±€ï¼šå…¨é»‘ã€å±…ä¸­ã€ç¦æ­¢é€‰æ‹© */
        body {
            background-color: #000000;
            color: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            user-select: none; /* ç¦æ­¢é€‰ä¸­æ–‡æœ¬ */
            -webkit-user-select: none;
            transition: background-color 0.5s; /* å˜è‰²æ—¶çš„è¿‡æ¸¡åŠ¨ç”» */
        }

        /* 2. å¿ƒç‡æ•°å­—ï¼šè¶…å¤§è‡ªé€‚åº” */
        #heartRate {
            font-size: 40vw; /* å±å¹•å®½åº¦çš„ 40%ï¼Œæå¤§ */
            font-weight: 800;
            font-variant-numeric: tabular-nums;
            line-height: 1;
            z-index: 2;
        }

        /* 3. å•ä½ BPM */
        .unit {
            font-size: 5vw;
            color: #666;
            margin-top: -10px;
            font-weight: 400;
            opacity: 0.6;
        }

        /* 4. è¿æ¥æŒ‰é’® */
        button {
            position: absolute; /* æ‚¬æµ®åœ¨ä¸­é—´ */
            bottom: 20%;        /* åä¸‹æ”¾ç½® */
            padding: 15px 35px;
            font-size: 18px;
            background-color: #222;
            color: #fff;
            border: 1px solid #444;
            border-radius: 50px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            z-index: 10;
        }

        /* è¿æ¥æˆåŠŸåï¼Œè®©æŒ‰é’®å½»åº•æ¶ˆå¤± */
        body.connected button {
            display: none;
        }

        /* 5. åº•éƒ¨å¾®å¼±æç¤ºæ–‡å­— */
        #hint {
            position: absolute;
            bottom: 20px;
            font-size: 12px;
            color: #333;
            pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€ */
        }
    </style>
</head>
<body>

    <div id="heartRate">--</div>
    <div class="unit">BPM</div>

    <button id="connectBtn">ğŸ”— è¿æ¥æ‰‹ç¯</button>
    <div id="hint">åŒå‡»å±å¹•åˆ‡æ¢å…¨å±</div>

    <script>
        const connectBtn = document.getElementById('connectBtn');
        const heartRateDisplay = document.getElementById('heartRate');
        const hint = document.getElementById('hint');
        
        let wakeLock = null;

        // --- 1. éšå¼å…¨å±é€»è¾‘ (åŒå‡»è§¦å‘) ---
        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(e => console.log(e));
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
        }
        // ç›‘å¬æ•´ä¸ªå±å¹•çš„åŒå‡»
        document.body.addEventListener('dblclick', toggleFullScreen);


        // --- 2. å±å¹•å¸¸äº®é€»è¾‘ (åå°è‡ªåŠ¨å¤„ç†) ---
        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log("å±å¹•å¸¸äº®å·²æ¿€æ´»");
                } catch (err) {
                    console.log("å¸¸äº®å¤±è´¥");
                }
            }
        }
        // åˆ‡å›æ¥æ—¶é‡æ–°ç”³è¯·é”
        document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') {
                await requestWakeLock();
            }
        });


        // --- 3. è“ç‰™è¿æ¥æ ¸å¿ƒé€»è¾‘ ---
        connectBtn.addEventListener('click', async () => {
            try {
                hint.innerText = "æ­£åœ¨æœç´¢...";
                
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: ['heart_rate'] }]
                });

                const server = await device.gatt.connect();
                const service = await server.getPrimaryService('heart_rate');
                const char = await service.getCharacteristic('heart_rate_measurement');

                await char.startNotifications();
                char.addEventListener('characteristicvaluechanged', handleHeartRateChanged);

                // è¿æ¥æˆåŠŸï¼š
                // 1. ç»™ body åŠ æ ‡è®°ï¼Œè§¦å‘ CSS éšè—æŒ‰é’®
                document.body.classList.add('connected');
                // 2. æ¿€æ´»å±å¹•å¸¸äº®
                await requestWakeLock();
                // 3. æ›´æ–°æç¤ºæ–‡å­—
                hint.innerText = "âš¡ å¸¸äº®ä¸­ Â· åŒå‡»å…¨å±";
                hint.style.color = "#004400"; // ææš—çš„ç»¿è‰²ï¼Œä¸åˆºçœ¼

                device.addEventListener('gattserverdisconnected', onDisconnected);

            } catch (error) {
                hint.innerText = "è¿æ¥å¤±è´¥ï¼Œè¯·é‡è¯•";
            }
        });

        // --- 4. æ•°æ®è§£æä¸å˜è‰² ---
        function handleHeartRateChanged(event) {
            const value = event.target.value;
            const flags = value.getUint8(0);
            let hr = (flags & 0x01) ? value.getUint16(1, true) : value.getUint8(1);

            heartRateDisplay.innerText = hr;
            
            // åŠ¨æ€å˜è‰²é€»è¾‘
            if (hr < 110) {
                heartRateDisplay.style.color = "#fff"; // ç™½
            } else if (hr < 140) {
                heartRateDisplay.style.color = "#00ffcc"; // é’
            } else if (hr < 170) {
                heartRateDisplay.style.color = "#ffcc00"; // é»„
            } else {
                heartRateDisplay.style.color = "#ff3333"; // çº¢
                // æé«˜å¿ƒç‡èƒŒæ™¯å¾®çº¢é—ªçƒ
                document.body.style.backgroundColor = (hr > 180) ? "#220000" : "#000000";
            }
        }

        function onDisconnected() {
            document.body.classList.remove('connected');
            heartRateDisplay.innerText = "--";
            heartRateDisplay.style.color = "#fff";
            hint.innerText = "å·²æ–­å¼€";
            wakeLock = null;
        }
    </script>
</body>
</html>